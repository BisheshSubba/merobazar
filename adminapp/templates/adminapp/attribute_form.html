{% extends "adminapp/admin_base.html" %}

{% block extra_css %}
<style>
    /* Custom Namespaced Styles */
    .attr-form-container {
        font-family: 'Segoe UI', Roboto, sans-serif;
        max-width: 900px;
        margin: 0 auto;
    }

    .attr-form-card {
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.15);
        border: none;
        overflow: hidden;
        margin-bottom: 2.5rem;
    }

    .attr-form-header {
        background: linear-gradient(135deg, #4361ee, #3a0ca3);
        color: white;
        padding: 1.5rem 2rem;
        border-bottom: none;
    }

    .attr-form-title {
        margin: 0;
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: 0.5px;
    }

    .attr-form-body {
        padding: 2rem;
        background-color: #f8fafc;
    }

    .attr-form-section {
        margin-bottom: 2.5rem;
        padding-bottom: 1.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .attr-form-section:last-child {
        border-bottom: none;
    }

    .attr-section-title {
        color: #3a0ca3;
        font-size: 1.2rem;
        margin-bottom: 1.75rem;
        font-weight: 600;
        position: relative;
        padding-left: 1.25rem;
    }

    .attr-section-title::before {
        content: "";
        position: absolute;
        left: 0;
        top: 3px;
        height: 24px;
        width: 5px;
        background: linear-gradient(to bottom, #4361ee, #7209b7);
        border-radius: 3px;
    }

    .attr-form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -12px;
    }

    .attr-form-group {
        padding: 0 12px;
        margin-bottom: 1.5rem;
        flex: 0 0 50%;
        max-width: 50%;
    }

    .attr-form-label {
        display: block;
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
    }

    .attr-form-input,
    .attr-form-select {
        display: block;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 8px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .attr-form-input:focus,
    .attr-form-select:focus {
        border-color: #4361ee;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    .attr-has-icon {
        position: relative;
    }

    .attr-input-icon {
        position: absolute;
        left: 1rem;
        top: 2.8rem;
        color: #6c757d;
        font-size: 1rem;
    }

    .attr-has-icon .attr-form-input,
    .attr-has-icon .attr-form-select {
        padding-left: 2.75rem;
    }

    .attr-form-check {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .attr-form-check-input {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        appearance: none;
        position: relative;
    }

    .attr-form-check-input:checked {
        background-color: #4361ee;
        border-color: #4361ee;
    }

    .attr-form-check-input:checked::after {
        content: "âœ“";
        position: absolute;
        color: white;
        font-size: 0.9rem;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .attr-form-check-label {
        font-weight: 500;
        color: #495057;
        cursor: pointer;
    }

    .attr-textarea-field textarea {
        min-height: 120px;
        resize: vertical;
    }

    .attr-form-footer {
        padding: 1.5rem 2rem;
        background-color: transparent;
        border-top: none;
        display: flex;
        gap: 1rem;
    }

    .attr-form-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        gap: 0.5rem;
        border: none;
    }

    .attr-btn-primary {
        background-color: #4361ee;
        color: white;
    }

    .attr-btn-primary:hover {
        background-color: #3a56d4;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }

    .attr-btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .attr-btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .attr-invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #dc3545;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .attr-form-group {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .attr-form-body {
            padding: 1.5rem;
        }
        
        .attr-form-footer {
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .attr-form-btn {
            width: 100%;
        }
        
        .attr-input-icon {
            top: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="attr-form-container">
    <div class="attr-form-card">
        <div class="attr-form-header">
            <h3 class="attr-form-title">{{ title }}</h3>
        </div>
        <form method="post" id="attribute-form">
            <div class="attr-form-body">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="attr-form-section">
                    <h5 class="attr-section-title">Attribute Details</h5>
                    <div class="attr-form-row">
                        <div class="attr-form-group attr-has-icon">
                            <label for="{{ form.name.id_for_label }}" class="attr-form-label">Attribute Name</label>
                            <i class="fas fa-tag attr-input-icon"></i>
                            <input type="text" name="{{ form.name.name }}" 
                                   class="attr-form-input" id="{{ form.name.id_for_label }}"
                                   value="{{ form.name.value|default_if_none:'' }}">
                            {% if form.name.errors %}
                                <div class="attr-invalid-feedback">
                                    {{ form.name.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="attr-form-group attr-has-icon">
                            <label for="{{ form.data_type.id_for_label }}" class="attr-form-label">Data Type</label>
                            <i class="fas fa-code attr-input-icon"></i>
                            <select name="{{ form.data_type.name }}" 
                                    class="attr-form-select" id="{{ form.data_type.id_for_label }}">
                                {% for value, label in form.data_type.field.choices %}
                                    <option value="{{ value }}" {% if form.data_type.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.data_type.errors %}
                                <div class="attr-invalid-feedback">
                                    {{ form.data_type.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="attr-form-row">
                        <div class="attr-form-group">
                            <div class="attr-form-check">
                                <input type="checkbox" name="{{ form.is_required.name }}" 
                                       class="attr-form-check-input" id="{{ form.is_required.id_for_label }}"
                                       {% if form.is_required.value %}checked{% endif %}>
                                <label class="attr-form-check-label" for="{{ form.is_required.id_for_label }}">
                                    Required Attribute
                                </label>
                            </div>
                        </div>
                        
                        <div class="attr-form-group attr-textarea-field">
                            <label for="{{ form.options.id_for_label }}" class="attr-form-label">Options (if applicable)</label>
                            <textarea name="{{ form.options.name }}" 
                                      class="attr-form-input" id="{{ form.options.id_for_label }}"
                                      rows="4">{{ form.options.value|default_if_none:'' }}</textarea>
                            {% if form.options.errors %}
                                <div class="attr-invalid-feedback">
                                    {{ form.options.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if not form.instance.pk %}
                <div class="attr-form-section">
                    <h5 class="attr-section-title">Assignment</h5>
                    <div class="attr-form-row">
                        <div class="attr-form-group attr-has-icon">
                            <label for="{{ form.apply_to.id_for_label }}" class="attr-form-label">Apply To</label>
                            <i class="fas fa-layer-group attr-input-icon"></i>
                            <select name="{{ form.apply_to.name }}" 
                                    class="attr-form-select" id="{{ form.apply_to.id_for_label }}">
                                {% for value, label in form.apply_to.field.choices %}
                                    <option value="{{ value }}" {% if form.apply_to.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.apply_to.errors %}
                                <div class="attr-invalid-feedback">
                                    {{ form.apply_to.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="attr-form-group attr-has-icon">
                            <label for="{{ form.content_type.id_for_label }}" class="attr-form-label">Target</label>
                            <i class="fas fa-bullseye attr-input-icon"></i>
                            <select name="{{ form.content_type.name }}" 
                                    class="attr-form-select" id="{{ form.content_type.id_for_label }}">
                                {% for value, label in form.content_type.field.choices %}
                                    <option value="{{ value }}" {% if form.content_type.value == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.content_type.errors %}
                                <div class="attr-invalid-feedback">
                                    {{ form.content_type.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                    <input type="hidden" name="{{ form.apply_to.name }}" value="{{ form.apply_to.value }}">
                    <input type="hidden" name="{{ form.content_type.name }}" value="{{ form.content_type.value }}">
                {% endif %}
                
                <input type="hidden" name="{{ form.object_id.name }}" value="{{ form.object_id.value|default_if_none:'' }}">
            </div>
            <div class="attr-form-footer">
                <button type="submit" class="attr-form-btn attr-btn-primary">
                    <i class="fas fa-save"></i> Save Attribute
                </button>
                <a href="{% url 'manage_categories' %}" class="attr-form-btn attr-btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const applyToSelect = document.getElementById('{{ form.apply_to.id_for_label }}');
        const contentTypeField = document.getElementById('{{ form.content_type.id_for_label }}');
        
        if (applyToSelect && contentTypeField) {
            applyToSelect.addEventListener('change', function() {
                const applyTo = this.value;
                if (applyTo) {
                    fetch(`/products/get-content-types/?apply_to=${applyTo}`)
                        .then(response => response.json())
                        .then(data => {
                            contentTypeField.innerHTML = '';
                            data.content_types.forEach(ct => {
                                const option = document.createElement('option');
                                option.value = ct.id;
                                option.textContent = ct.name;
                                contentTypeField.appendChild(option);
                            });
                        });
                }
            });
            
            if (applyToSelect.value) {
                applyToSelect.dispatchEvent(new Event('change'));
            }
        }
        
        if (typeof $ !== 'undefined' && $.fn.select2) {
            $('.attr-form-select').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        }
    });
</script>
{% endblock %}